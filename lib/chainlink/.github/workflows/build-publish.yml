name: "Build, Sign and Publish Chainlink"

on:
  push:
    tags:
      - "v*"

permissions: {}

jobs:
  checks:
    name: "Checks"
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    outputs:
      is-release: ${{ steps.release-tag-check.outputs.is-release }}
      is-pre-release: ${{ steps.release-tag-check.outputs.is-pre-release }}
      ccip-image-tag: ${{ steps.compute-ccip-tag.outputs.ccip-image-tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false
      - name: Check release tag
        id: release-tag-check
        uses: smartcontractkit/.github/actions/release-tag-check@c5c4a8186da4218cff6cac8184e47dd3dec69ba3 # release-tag-check@0.1.0
      - name: Compute CCIP image tag
        id: compute-ccip-tag
        shell: bash
        env:
          GIT_TAG: ${{ github.ref_name }}
        run: |
          # Compute CCIP-specific image tag by inserting '-ccip' before pre-release identifier
          # Examples:
          #   v2.34.0-rc.1   -> 2.34.0-ccip-rc.1
          #   v2.34.0-beta.0 -> 2.34.0-ccip-beta.0
          tag_without_v="${GIT_TAG#v}"
          ccip_tag=$(echo "$tag_without_v" | sed -E 's/^([0-9]+\.[0-9]+\.[0-9]+)-(.*)$/\1-ccip-\2/')
          echo "ccip-image-tag=$ccip_tag" | tee -a "$GITHUB_OUTPUT"
      - name: Check for VERSION file bump on tags
        if: ${{ github.repository == 'smartcontractkit/chainlink' }}
        uses: ./.github/actions/version-file-bump
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

  docker-core:
    needs: [checks]
    # No need to build the final image as we promote the last RC to use the final tag
    # so we only run the builds for pre-releases.
    if: needs.checks.outputs.is-pre-release == 'true'
    permissions:
      contents: read
      id-token: write
    uses: smartcontractkit/.github/.github/workflows/reusable-docker-build-publish.yml@a89ebdd9d9cabda77c5f7ea7523af5707afb7786 # 2025-08-25
    with:
      aws-ecr-name: chainlink
      aws-region-ecr: us-east-1
      aws-region-gati: us-west-2
      dockerfile: core/chainlink.Dockerfile
      docker-build-context: .
      docker-build-args: |
        CHAINLINK_USER=chainlink
        COMMIT_SHA=${{ github.sha }}
        VERSION_TAG=${{ github.ref_name }}
      docker-cache-behaviour: "disable"
      docker-manifest-sign: true
      docker-registry-url-override: public.ecr.aws/chainlink
      docker-image-tag-strip-prefix: v # strip out the "v" prefix from the git tag for the image tag.
      git-sha: ${{ github.sha }}
      github-event-name: ${{ github.event_name }}
      github-ref-name: ${{ github.ref_name }}
      github-ref-type: ${{ github.ref_type}}
      github-workflow-repository: ${{ github.repository }}
    secrets:
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID_SDLC }}
      AWS_ROLE_PUBLISH_ARN: ${{ secrets.AWS_OIDC_IAM_ROLE_SDLC_BUILD_PUBLISH_ARN }}
      AWS_ROLE_GATI_ARN: ${{ secrets.AWS_OIDC_CHAINLINK_READ_ONLY_TOKEN_ISSUER_ROLE_ARN }}
      AWS_LAMBDA_GATI_URL: ${{ secrets.AWS_INFRA_RELENG_TOKEN_ISSUER_LAMBDA_URL }}

  docker-ccip:
    needs: [checks]
    # No need to build the final image as we promote the last RC to use the final tag
    # so we only run the builds for pre-releases.
    if: needs.checks.outputs.is-pre-release == 'true'
    permissions:
      contents: read
      id-token: write
    uses: smartcontractkit/.github/.github/workflows/reusable-docker-build-publish.yml@a89ebdd9d9cabda77c5f7ea7523af5707afb7786 # 2025-08-25
    with:
      aws-ecr-name: ccip
      aws-region-ecr: us-east-1
      aws-region-gati: us-west-2
      dockerfile: core/chainlink.Dockerfile
      docker-build-context: .
      docker-build-args: |
        CHAINLINK_USER=chainlink
        COMMIT_SHA=${{ github.sha }}
        VERSION_TAG=${{ github.ref_name }}
        CL_INSTALL_PRIVATE_PLUGINS=true
        CL_CHAIN_DEFAULTS=/ccip-config
        CL_SOLANA_CMD=
      docker-cache-behaviour: "disable"
      docker-manifest-sign: true
      docker-registry-url-override: public.ecr.aws/chainlink
      docker-image-tag-override: ${{ needs.checks.outputs.ccip-image-tag }}
      git-sha: ${{ github.sha }}
      github-event-name: ${{ github.event_name }}
      github-ref-name: ${{ github.ref_name }}
      github-ref-type: ${{ github.ref_type}}
      github-workflow-repository: ${{ github.repository }}
    secrets:
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID_SDLC }}
      AWS_ROLE_PUBLISH_ARN: ${{ secrets.AWS_OIDC_IAM_ROLE_SDLC_BUILD_PUBLISH_ARN }}
      AWS_ROLE_GATI_ARN: ${{ secrets.AWS_OIDC_CHAINLINK_READ_ONLY_TOKEN_ISSUER_ROLE_ARN }}
      AWS_LAMBDA_GATI_URL: ${{ secrets.AWS_INFRA_RELENG_TOKEN_ISSUER_LAMBDA_URL }}

  # Notify Slack channel for new git tags associated with pre-releases.
  # Final release notifications originate from the release coordinator repo.
  slack-notify-core:
    permissions:
      contents: read
    if: always() && needs.docker-core.result == 'success'
    needs: [checks, docker-core]
    uses: ./.github/workflows/release-notifications.yml
    secrets: inherit
    with:
      git-ref: ${{ github.ref_name }}
      git-ref-type: ${{ github.ref_type }}
      changelog-url: >-
        ${{
          format(
            'https://github.com/{0}/blob/{1}/CHANGELOG.md',
            github.repository,
            github.ref_name
          )
        }}
      docker-image-name: >-
        ${{
          format(
            'public.ecr.aws/chainlink/chainlink:{0}',
            needs.docker-core.outputs.docker-manifest-tag
          )
        }}
      docker-image-digest: ${{ needs.docker-core.outputs.docker-manifest-digest }}

  slack-notify-ccip:
    permissions:
      contents: read
    if: always() && needs.docker-ccip.result == 'success'
    needs: [checks, docker-ccip]
    uses: ./.github/workflows/release-notifications.yml
    secrets: inherit
    with:
      git-ref: ${{ github.ref_name }}
      git-ref-type: ${{ github.ref_type }}
      changelog-url: >-
        ${{
          format(
            'https://github.com/{0}/blob/{1}/CHANGELOG.md',
            github.repository,
            github.ref_name
          )
        }}
      docker-image-name: >-
        ${{
          format(
            'public.ecr.aws/chainlink/ccip:{0}',
            needs.docker-ccip.outputs.docker-manifest-tag
          )
        }}
      docker-image-digest: ${{ needs.docker-ccip.outputs.docker-manifest-digest }}
